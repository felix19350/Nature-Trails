{% extends 'mapBase.html' %}
<!-- Load the trail onto the google map -->

{% block extraHeaders %}
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=geometry&sensor=false"></script>
<script type="text/javascript">
	google.load("visualization", "1", {packages:["corechart"]});

	var jsonTrail = $.parseJSON('{{ jsonTrail }}');
	$(function(){
		
		$("#details_trailName").html(jsonTrail.title);
		$("#details_credentialNum").html(jsonTrail.credentialNumber);
		$("#details_difficulty").html(jsonTrail.difficulty);
		$("#details_condition").html(jsonTrail.condition);
		$("#details_distance").html(jsonTrail.extension);
		$("#details_slope").html(jsonTrail.slope);
		$("#details_region").html(jsonTrail.region);
		$("#details_nearestCity").html(jsonTrail.nearestCity);
		
		var points = [];
		var numPoints = jsonTrail.points.length;
		var start = new google.maps.LatLng(jsonTrail.startPoint[0], jsonTrail.startPoint[1])
		

		//Create placemark for the start of the trail
		var marker = new google.maps.Marker({
      		position: start, 
      		map: map, 
     		title: jsonTrail.title,
     		icon: "/img/hiking.png"
  		}); 
  		
		//Set the center of the viewport
		map.setCenter(start);
		//Set the zoom level
		map.setZoom(13);
		
		if (numPoints > 0) {
		
			//Create the line chart
        	var rows = []

			var d = 0.0;
			var prev = null
			
			for ( var i = 0; i < numPoints; i++) {
				var temp = jsonTrail.points[i];
				var geoPt = new google.maps.LatLng(temp[0], temp[1]);
				points.push(geoPt);
				if(prev !== null){
					d += google.maps.geometry.spherical.computeDistanceBetween(prev, geoPt)
				}
				rows.push([d, parseFloat(temp[2])]);
				prev = geoPt;
			}

			//Draw the trail
			var trailLine = new google.maps.Polyline({
				path : points,
				strokeColor : "#FF0000",
				strokeOpacity : 1.0,
				strokeWeight : 2,
				map : map
			});
			
			//Update the data table for the height
			
			var data = new google.visualization.DataTable();
        	data.addColumn('number', 'Distance');
        	data.addColumn('number', 'Height');
        	
		var options = {
          width: 250, height: 175,
          title: 'Height variation',
          pointSize: 0,
          lineWidth: 1,
          legend:{
          	position: "bottom"
          },
          vAxis:{
          	title: "Height (m)"
          },
          hAxis:{
          	title: "Distance (m)"
          }
        };
			var chart = new google.visualization.ScatterChart(document.getElementById('chart_div'));
			data.addRows(rows);
        	chart.draw(data, options);
		} else {
			alert("no coordinates");
		}
		

		$.ajax({
			url:'/trailDetails',
			data: {trailId: jsonTrail.key},
			success: function(data){
				$("#trailDetails").html(data);	
			}
		});
		
		//Add overlays:
		var layer = undefined;
		
		$("#zpeOverlay").click(function(){
			if($(this).is(":checked")){
				if(layer === undefined){
					$.jnotify("Fetching layer, standby...", 10000);
					layer = new google.maps.KmlLayer("http://ruinmaps.appspot.com/docs/zpe.kmz");
				}
				layer.setMap(map);
			}else{
				if(layer !== undefined){
					layer.setMap(null);
				}
			}
		});
		
	});			
</script>
{% endblock %}

<!-- Details for a specific trail -->
{% block contents %}
<div>
	<!-- top logo -->
	<div class="ui-helper-clearfix">
		<div class="left">
			<a href="/trails">Back</a>
		</div>
		<div class="right">
			<div id="updateButton">Update</div>
			<script type="text/javascript">
				$("#updateButton").button().click(function(){
					$("#updateTrailDialog").dialog("open");
				});			
			</script>
		</div>
		<div class="right">
			<div id="deleteButton">Delete</div>
			<script type="text/javascript">
				$("#deleteButton").button().click(function(){
					alert("The delete operation is currently disabled.");
					//TODO: add a confirmation dialog.
					/*$.ajax({
						url: "/trail/"+jsonTrail.key,
						type: "DELETE",
						success: function(){
							window.location.href = "/trails";
						}
					});*/
				});
			</script>	
		</div>
	</div>
	
	<fieldset>
		<legend>Trail information</legend>
		<p>
			<span class="itemLabel">Trail:</span>
			<span id="details_trailName">{{ trail.title }}</span>
		</p>
		<p>
			<span class="itemLabel">Credential:</span>
			<span id="details_credentialNum">{{ trail.credentialNumber }}</span>
		</p>
		<p>
			<span class="itemLabel">Condition:</span>
			<span id="details_condition">{{ trail.condition }}</span>
		</p>
		<p>
			<span class="itemLabel">Distance (Km):</span>
			<span id="details_distance">{{ trail.extension }}</span>
		</p>
		<p>
			<span class="itemLabel">Slope (m):</span>
			<span id="details_slope">{{ trail.slope }}</span>
		</p>
		<p>
			<span class="itemLabel">Difficulty:</span>
			<span id="details_difficulty">{{ trail.difficulty }}</span>
		</p>
		<p>
			<span class="itemLabel">Region:</span>
			<span id="details_region">{{ trail.region }}</span>
		</p>
		<p>
			<span class="itemLabel">Nearest city:</span>
			<span id="details_nearestCity">{{ trail.nearestCity }}</span>
		</p>
	</fieldset>
	
	<div id="trailDetails">
	</div>
	
	<!-- Extras in the map -->
	
	
	<div style="position: absolute; top: 100px; right: 0px; z-index: 4500; font-size: 12px; background-color: white; width: 250px; padding: 5px;">
		<div>
		<p>Layers:</p>
		<input type="checkbox" id="zpeOverlay"/><label for="zpeOverlay"> ZPE - (Zonas de prot. especial)</label>
		</div>
		<div id="chart_div"></div>
	</div>
</div>

<!-- Add the update dialog for this trail -->
{% include "_trails/editTrailDialog.html" %}

{% endblock %}